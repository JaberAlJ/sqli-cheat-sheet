# Stacked Queries (Piggybacked Queries)

> [!WARNING]
> **Ethics reminder:** Stacked queries can execute additional SQL statements on the target database (e.g., `; DROP TABLE ...`). These are extremely dangerous and should only be tested in authorized, controlled environments (local labs or explicit penetration-test scopes). Never use stacked-query payloads against production systems without permission.

---

## What are stacked queries?

Stacked (or piggybacked) queries occur when multiple SQL statements are sent in a single request and the DB executes them sequentially. Attackers exploit vulnerable input to terminate the original statement and append new statements separated by statement delimiters (commonly `;`). This can allow data extraction, state changes, or destructive actions.

Not all DB APIs or drivers allow multiple statements per request â€” many modern frameworks disable them by default. However, where allowed, stacked queries are powerful and dangerous.

---

## Example vulnerable pattern

Application constructs SQL by concatenation:

```sql
query = "SELECT * FROM users WHERE id = '" + user_input + "'"
```

If `user_input` is `1'; DROP TABLE users; --`, the resulting SQL becomes:

```sql
SELECT * FROM users WHERE id = '1'; DROP TABLE users; --'
```

If multiple statements are permitted, this will run both the SELECT and the destructive DROP.

---

## Common payload patterns

* Basic statement termination + new statement:

```
'; DROP TABLE users; --
```

* Non-destructive data-retrieval piggyback (lab-only):

```
'; INSERT INTO audit_log(content) VALUES('pwned'); --
```

* Combining with UNION/SELECT techniques is possible depending on context and permissions.

**Important:** Many DB drivers reject multiple statements by default; attackers may try different encodings or API-specific techniques to bypass restrictions.

---

## DBMS & API behavior

* **MySQL**: `;` is statement separator. Some connectors (e.g., `mysql` in Node.js) disallow multipleStatements unless explicitly enabled.
* **PostgreSQL**: supports multiple statements; but some client libraries restrict them.
* **MSSQL**: supports batch separators (semicolon) and `GO` in some tools; behavior varies by API.
* **Oracle**: typically executes single statements per API call; stacked queries are less common in typical app APIs.

Always consider the application framework and driver when evaluating stacked-query risk.

---

## Detection (authorized)

* Try simple statement terminators in safe, controlled tests: `' ; --` or `'; SELECT 'X' --` and observe whether additional results/actions are executed.
* Monitor server-side logs (if within scope) to detect multiple statements from one request.
* Use low-risk payloads (e.g., append `; SELECT 1 --`) to test whether additional statements run.

---

## Risks and impact

* **High impact:** Ability to modify schema, delete data, or escalate actions (e.g., add admin user) depending on DB privileges.
* **Immediate destructive potential:** Many stacked-query payloads can cause irreversible data loss.
* **Auditable:** These attacks often produce clear evidence in DB logs, so they can be detected after the fact.

---

## Defensive measures

1. **Disable multiple statements** in DB client connectors unless explicitly required.
2. **Use prepared statements / parameterized queries** which typically treat user input as data, not code.
3. **Validate and canonicalize input**; disallow statement terminators or unexpected characters when not needed.
4. **Least privilege:** application DB user should lack permissions to perform destructive operations (DROP, ALTER) where possible.
5. **Web Application Firewalls (WAFs):** can block common stacked-query patterns, but should not be relied upon solely.
6. **Audit & logging:** detect anomalous statements or multi-statement requests.

---

## Responsible testing guidance

> [!TIP]
> * Prefer non-destructive probes (`; SELECT 1 --`) when checking for stacked-query support.
> * Never run destructive payloads (`DROP`, `TRUNCATE`) during discovery unless explicitly allowed and coordinated.
> * Document tests, timestamps, and observed behavior carefully.